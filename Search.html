<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”</text></svg>">
    <style>
        /* ä¿æŒä½ åŸæœ¬çš„ CSS æ¨£å¼ä¸è®Š */
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 20px 0; background: #f0f2f5; color: #333; font-size: 12px; display: flex; justify-content: center; }
        .main-container { width: 95%; max-width: 450px; display: flex; flex-direction: column; }
        .header { display: flex; gap: 0; margin-bottom: 15px; position: sticky; top: 0; background: #f0f2f5; padding: 10px 0; z-index: 100; border-bottom: 2px solid #ddd; }
        .search-box { flex: 1; display: flex; }
        input[type="text"] { flex: 1; padding: 10px 14px; border: 1px solid #ccc; border-radius: 6px 0 0 6px; background: #fff; color: #000; outline: none; font-size: 14px; transition: 0.2s; }
        input[type="text"]:focus { border-color: #007bff; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        button#mainSearch { padding: 10px 24px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 0 6px 6px 0; font-weight: bold; font-size: 14px; }
        button#mainSearch:hover { background: #0056b3; }
        .btn-toggle { margin-left: 12px; padding: 10px 15px; font-size: 12px; cursor: pointer; background: #fff; color: #555; border: 1px solid #ccc; border-radius: 6px; white-space: nowrap; font-weight: 500; }
        .btn-toggle:hover { background: #f1f1f1; border-color: #bbb; }
        .tag-row { display: flex; align-items: flex-start; margin-bottom: 8px; padding: 8px 12px; background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .tag-row:hover { border-color: #007bff; background: #fafafa; }
        .tag-label { min-width: 85px; font-weight: bold; color: #007bff; font-size: 11px; flex-shrink: 0; padding-top: 5px; text-transform: uppercase; }
        .site-container { display: flex; flex-wrap: wrap; gap: 6px; flex: 1; }
        .site-item input { display: none; }
        .site-item { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: #f1f3f5; border-radius: 10px; cursor: pointer; border: 1px solid #e9ecef; transition: all 0.15s ease; user-select: none; color: #495057; font-weight: 500; }
        .site-item:hover { background: #e9ecef; }
        .site-item.active { background: #212529; color: #fff; border-color: #212529; }
        .site-icon { width: 14px; height: 14px; object-fit: contain; background: #fff; padding: 1px; border-radius: 50%; flex-shrink: 0; border: 1px solid #eee; }
        .footer { font-size: 11px; color: #888; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="header">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="è¼¸å…¥é—œéµå­—..." autocomplete="off">
                <button id="mainSearch" onclick="startSearch()">æœå°‹</button>
            </div>
            <button class="btn-toggle" onclick="toggleAllGlobal()">å…¨é¸/æ¸…ç©º</button>
        </div>

        <div id="content"></div>
    </div>

    <script>
        // 1. è¨­å®šè©¦ç®—è¡¨ ID èˆ‡å·¥ä½œè¡¨åç¨±
        const spreadsheetId = "1derDn2oXg3-NbMNoVtLwvye466dophZVOgrDID-rlbg";
        const pageName = "Search"; // ä½ çš„å·¥ä½œè¡¨åç¨±

        let siteData = [];

        function getIcon(url) {
            try {
                return `https://www.google.com/s2/favicons?sz=64&domain=${new URL(url).hostname}`;
            } catch (e) {
                return "ğŸ”—";
            }
        }

        async function init() {
            // 2. çµ„åˆ Google Sheets API URL
            const sheetURL = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(pageName)}`;

            try {
                const res = await fetch(sheetURL);
                const text = await res.text();
                
                // 3. è§£æ CSV (æ”¯æ´ \r\n æ›è¡Œä¸¦ç§»é™¤é›™å¼•è™Ÿ)
                const rows = text.split(/\r?\n/)
                                 .map(row => row.trim().replace(/^"|"$/g, ''))
                                 .filter(l => l !== "");

                const prefs = JSON.parse(localStorage.getItem('searchPrefs') || '{}');
                const groups = {};

                rows.forEach((row, i) => {
                    // è§£ææ¯ä¸€åˆ—ï¼Œç§»é™¤ Google CSV è‡ªå‹•åŠ ä¸Šçš„é›™å¼•è™Ÿ
                    const cols = row.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                    
                    if (cols.length < 3) return;
                    
                    const site = { 
                        id: i, 
                        name: cols[0], // A æ¬„ï¼šç¶²ç«™åç¨±
                        url: cols[1],  // B æ¬„ï¼šæœå°‹ç¶²å€ (å« KEYWORD)
                        tag: cols[2]   // C æ¬„ï¼šåˆ†é¡æ¨™ç±¤
                    };
                    
                    siteData.push(site);
                    if (!groups[site.tag]) groups[site.tag] = [];
                    groups[site.tag].push(site);
                });
                
                render(groups, prefs);
            } catch (err) { 
                console.error("åˆå§‹åŒ–å¤±æ•—:", err); 
                document.getElementById('content').innerHTML = `<div style="text-align:center; padding:20px; color:red;">è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨å…±ç”¨æ¬Šé™æˆ–å·¥ä½œè¡¨åç¨± [${pageName}]</div>`;
            }
        }

        function render(groups, prefs) {
            const container = document.getElementById('content');
            container.innerHTML = ""; // æ¸…ç©ºå…§å®¹

            for (const [tag, sites] of Object.entries(groups)) {
                const row = document.createElement('div');
                row.className = 'tag-row';
                row.onclick = (e) => {
                    if (!e.target.closest('.site-item')) toggleTag(tag);
                };

                row.innerHTML = `
                    <div class="tag-label">ğŸ·ï¸ ${tag}</div>
                    <div class="site-container" id="g-${tag}"></div>
                `;
                container.appendChild(row);

                const grid = document.getElementById(`g-${tag}`);
                sites.forEach(s => {
                    // é è¨­é¸ä¸­ (é™¤é localStorage ç´€éŒ„ç‚º false)
                    const checked = prefs[s.name] !== false;
                    const label = document.createElement('label');
                    label.className = `site-item ${checked ? 'active' : ''}`;
                    label.dataset.name = s.name;
                    label.dataset.tag = tag;
                    
                    label.innerHTML = `
                        <input type="checkbox" value="${s.id}" ${checked ? 'checked' : ''}>
                        <img src="${getIcon(s.url)}" class="site-icon">
                        <span>${s.name}</span>
                    `;

                    label.onclick = (e) => {
                        const cb = label.querySelector('input');
                        cb.checked = !cb.checked;
                        label.classList.toggle('active', cb.checked);
                        save();
                        e.stopPropagation();
                        e.preventDefault(); // ä¿®æ­£ label é»æ“Šå…©æ¬¡çš„å•é¡Œ
                    };

                    grid.appendChild(label);
                });
            }
        }

        function toggleAllGlobal() {
            const items = document.querySelectorAll('.site-item');
            const someUnchecked = Array.from(items).some(item => !item.querySelector('input').checked);
            items.forEach(item => {
                const cb = item.querySelector('input');
                cb.checked = someUnchecked;
                item.classList.toggle('active', someUnchecked);
            });
            save();
        }

        function toggleTag(t) {
            const items = document.querySelectorAll(`.site-item[data-tag="${t}"]`);
            const someUnchecked = Array.from(items).some(item => !item.querySelector('input').checked);
            items.forEach(item => {
                const cb = item.querySelector('input');
                cb.checked = someUnchecked;
                item.classList.toggle('active', someUnchecked);
            });
            save();
        }

        function save() {
            const p = {};
            document.querySelectorAll('.site-item').forEach(item => {
                p[item.dataset.name] = item.querySelector('input').checked;
            });
            localStorage.setItem('searchPrefs', JSON.stringify(p));
        }

        async function startSearch() {
            const input = document.getElementById('searchInput');
            const kw = input.value.trim();
            if (!kw) return;
            
            const checkedBoxes = document.querySelectorAll('.site-item input:checked');
            const sel = Array.from(checkedBoxes).map(c => siteData[c.value]);
            
            if (sel.length > 5 && !confirm(`å³å°‡é–‹å•Ÿ ${sel.length} å€‹åˆ†é ï¼Œç¢ºå®šå—ï¼Ÿ`)) return;

            input.value = '';
            for (let i = 0; i < sel.length; i++) {
                window.open(sel[i].url.replace('KEYWORD', encodeURIComponent(kw)), '_blank');
                // å»¶é²ä¸€é»æ™‚é–“é˜²æ­¢è¢«ç€è¦½å™¨è¦–ç‚ºå»£å‘Šå½ˆçª—é˜»æ“‹
                if (i < sel.length - 1) await new Promise(r => setTimeout(r, 600));
            }
        }

        document.getElementById('searchInput').addEventListener('keypress', e => { 
            if(e.key === 'Enter') startSearch(); 
        });

        init();
    </script>
</body>
</html>