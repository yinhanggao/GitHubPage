<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>私人搜尋站</title>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 20px 0; background: #f0f2f5; color: #333; font-size: 12px; display: flex; justify-content: center; }
        
        .main-container { width: 95%; max-width: 450px; display: flex; flex-direction: column; }

        /* 頂部搜尋欄 */
        .header { display: flex; gap: 0; margin-bottom: 15px; position: sticky; top: 0; background: #f0f2f5; padding: 10px 0; z-index: 100; border-bottom: 2px solid #ddd; }
        .search-box { flex: 1; display: flex; }
        input[type="text"] { flex: 1; padding: 10px 14px; border: 1px solid #ccc; border-radius: 6px 0 0 6px; background: #fff; color: #000; outline: none; font-size: 14px; transition: 0.2s; }
        input[type="text"]:focus { border-color: #007bff; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        button#mainSearch { padding: 10px 24px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 0 6px 6px 0; font-weight: bold; font-size: 14px; }
        button#mainSearch:hover { background: #0056b3; }
        
        .btn-toggle { margin-left: 12px; padding: 10px 15px; font-size: 12px; cursor: pointer; background: #fff; color: #555; border: 1px solid #ccc; border-radius: 6px; white-space: nowrap; font-weight: 500; }
        .btn-toggle:hover { background: #f1f1f1; border-color: #bbb; }

        /* 分類列 */
        .tag-row { display: flex; align-items: flex-start; margin-bottom: 8px; padding: 8px 12px; background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .tag-row:hover { border-color: #007bff; background: #fafafa; }
        .tag-label { min-width: 85px; font-weight: bold; color: #007bff; font-size: 11px; flex-shrink: 0; padding-top: 5px; text-transform: uppercase; }

        .site-container { display: flex; flex-wrap: wrap; gap: 6px; flex: 1; }

        /* 隱藏原生 Checkbox */
        .site-item input { display: none; }

        /* 網站標籤樣式 (未選中) */
        .site-item { 
            display: flex; align-items: center; gap: 6px; padding: 4px 10px; 
            background: #f1f3f5; border-radius: 10px; cursor: pointer; 
            border: 1px solid #e9ecef; transition: all 0.15s ease; 
            user-select: none; color: #495057; font-weight: 500;
        }
        .site-item:hover { background: #e9ecef; }

        /* 網站標籤樣式 (選中後反白) */
        .site-item.active { 
            background: #212529; 
            color: #fff; 
            border-color: #212529;
        }

        .site-icon { width: 14px; height: 14px; object-fit: contain; background: #fff; padding: 1px; border-radius: 50%; flex-shrink: 0; border: 1px solid #eee; }
        
        .footer { font-size: 11px; color: #888; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="header">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="輸入關鍵字..." autocomplete="off">
                <button id="mainSearch" onclick="startSearch()">搜尋</button>
            </div>
            <button class="btn-toggle" onclick="toggleAllGlobal()">全選/清空</button>
        </div>

        <div id="content"></div>
        <div class="footer">© 2025 huh Demo</div>
    </div>

    <script>
        const CSV_PATH = 'assets/searchweb.csv';
        let siteData = [];

        function getIcon(url) {
            return `https://www.google.com/s2/favicons?sz=64&domain=${new URL(url).hostname}`;
        }

        async function init() {
            try {
                const res = await fetch(CSV_PATH);
                const text = await res.text();
                const rows = text.split('\n').filter(l => l.trim() !== "").slice(1);
                const prefs = JSON.parse(localStorage.getItem('searchPrefs') || '{}');

                const groups = {};
                rows.forEach((row, i) => {
                    const cols = row.split(',');
                    if (cols.length < 3) return;
                    const site = { id: i, name: cols[0].trim(), url: cols[1].trim(), tag: cols[2].trim() };
                    siteData.push(site);
                    if (!groups[site.tag]) groups[site.tag] = [];
                    groups[site.tag].push(site);
                });
                render(groups, prefs);
            } catch (err) { console.error("初始化失敗:", err); }
        }

        function render(groups, prefs) {
            const container = document.getElementById('content');
            for (const [tag, sites] of Object.entries(groups)) {
                const row = document.createElement('div');
                row.className = 'tag-row';
                row.onclick = (e) => {
                    if (!e.target.closest('.site-item')) toggleTag(tag);
                };

                row.innerHTML = `
                    <div class="tag-label"># ${tag}</div>
                    <div class="site-container" id="g-${tag}"></div>
                `;
                container.appendChild(row);

                const grid = document.getElementById(`g-${tag}`);
                sites.forEach(s => {
                    const checked = prefs[s.name] !== false;
                    const label = document.createElement('label');
                    label.className = `site-item ${checked ? 'active' : ''}`;
                    label.dataset.name = s.name;
                    label.dataset.tag = tag;
                    
                    label.innerHTML = `
                        <input type="checkbox" value="${s.id}" ${checked ? 'checked' : ''}>
                        <img src="${getIcon(s.url)}" class="site-icon">
                        <span>${s.name}</span>
                    `;

                    label.onclick = (e) => {
                        const cb = label.querySelector('input');
                        cb.checked = !cb.checked;
                        label.classList.toggle('active', cb.checked);
                        save();
                        e.stopPropagation();
                    };

                    grid.appendChild(label);
                });
            }
        }

        function toggleAllGlobal() {
            const items = document.querySelectorAll('.site-item');
            const someUnchecked = Array.from(items).some(item => !item.querySelector('input').checked);
            items.forEach(item => {
                const cb = item.querySelector('input');
                cb.checked = someUnchecked;
                item.classList.toggle('active', someUnchecked);
            });
            save();
        }

        function toggleTag(t) {
            const items = document.querySelectorAll(`.site-item[data-tag="${t}"]`);
            const someUnchecked = Array.from(items).some(item => !item.querySelector('input').checked);
            items.forEach(item => {
                const cb = item.querySelector('input');
                cb.checked = someUnchecked;
                item.classList.toggle('active', someUnchecked);
            });
            save();
        }

        function save() {
            const p = {};
            document.querySelectorAll('.site-item').forEach(item => {
                p[item.dataset.name] = item.querySelector('input').checked;
            });
            localStorage.setItem('searchPrefs', JSON.stringify(p));
        }

        async function startSearch() {
            const input = document.getElementById('searchInput');
            const kw = input.value.trim();
            if (!kw) return;
            const sel = Array.from(document.querySelectorAll('.site-item input:checked')).map(c => siteData[c.value]);
            input.value = '';
            for (let i = 0; i < sel.length; i++) {
                window.open(sel[i].url.replace('KEYWORD', encodeURIComponent(kw)), '_blank');
                if (i < sel.length - 1) await new Promise(r => setTimeout(r, 800));
            }
        }

        document.getElementById('searchInput').addEventListener('keypress', e => { 
            if(e.key === 'Enter') startSearch(); 
        });

        init();
    </script>
</body>
</html>