<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğ•-Search-Compiler</title>
    <style>
        /* åŸºç¤é¢¨æ ¼ï¼šå»¶çºŒç™½åº•ç°¡ç´„é¢¨ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { color: #1c1e21; margin-bottom: 10px; }

        /* ä½¿ç”¨èªªæ˜å€å¡Š */
        .instruction {
            background: #fff;
            max-width: 900px;
            width: 100%;
            padding: 15px 25px;
            border-radius: 12px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .instruction h2 { font-size: 16px; margin-top: 0; color: #1da1f2; }
        .instruction ul { margin: 0; padding-left: 20px; font-size: 13px; color: #555; line-height: 1.6; }

        /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
        #searchTable {
            background: #fff;
            border-collapse: collapse;
            width: 100%;
            max-width: 900px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #ddd;
            font-size: 13px;
        }

        #searchTable thead {
            background: #f8f9fa;
            border-bottom: 2px solid #eee;
        }

        #searchTable th, #searchTable td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        #searchTable td:nth-child(2) {
            text-align: left;
            font-weight: 500;
            color: #111;
        }

        /* æŒ‰éˆ•çµ„æ¨£å¼ */
        .btn-group {
            display: inline-flex;
            gap: 2px;
            background: #eee;
            padding: 2px;
            border-radius: 6px;
        }

        .btn-group button {
            border: none;
            background: transparent;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            color: #666;
            transition: 0.2s;
        }

        .btn-group button.selected {
            background: #212529;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #openSelected, .link-btn {
            background: #1da1f2;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        #openSelected:hover, .link-btn:hover { background: #1991db; }
        #openSelected { font-size: 16px; padding: 5px 15px; }

        input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }

        @media (max-width: 600px) {
            body { padding: 10px; }
            #searchTable { font-size: 11px; }
            .btn-group button { padding: 3px 5px; font-size: 10px; }
        }
    </style>
</head>
<body>

    <h1 id="pageTitle">ğ•-Search</h1>

    <div class="instruction">
        <h2 id="sheetInfo">ğŸ“Œ æ­£åœ¨è®€å–è³‡æ–™...</h2>
        <ul>
            <li>è¡¨æ ¼æ”¯æ´è¨­å®šæ„›å¿ƒæ•¸ã€æ—¥æœŸç¯„åœå’Œæ’åºã€‚</li>
            <li>é»æ“Š ğŸ”— æœå°‹å–®åˆ—ï¼Œæˆ–é»æ“Šæ¨™é ­çš„ ğŸŒ é–‹å•Ÿæ‰€æœ‰å·²å‹¾é¸çš„æœå°‹ã€‚</li>
            <li><b>æ³¨æ„ï¼š</b>å·¥ä½œè¡¨åç¨±å¿…é ˆèˆ‡ HTML æª”åä¸€è‡´ã€‚</li>
        </ul>
    </div>

    <table id="searchTable">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAllCheckbox" checked></th>
                <th>é—œéµå­— ğŸ”</th>
                <th>
                    <div class="btn-group" id="favesHeader">
                        <button data-val="any">â¤ï¸</button>
                        <button data-val="10" class="selected">10</button>
                        <button data-val="100">100</button>
                    </div>
                </th>
                <th>
                    <div class="btn-group" id="daysHeader">
                        <button data-val="any">ğŸ“…</button>
                        <button data-val="1">1</button>
                        <button data-val="7" class="selected">7</button>
                        <button data-val="30">30</button>
                    </div>
                </th>
                <th>
                    <div class="btn-group" id="sortHeader">
                        <button data-val="live" class="selected">âœ¨live</button>
                        <button data-val="top">ğŸ”¥top</button>
                    </div>
                </th>
                <th><button id="openSelected">ğŸŒ</button></th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="6">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>
        </tbody>
    </table>

    <script>
        // å›ºå®šè©¦ç®—è¡¨ ID
        const spreadsheetId = "1derDn2oXg3-NbMNoVtLwvye466dophZVOgrDID-rlbg";

        document.addEventListener("DOMContentLoaded", async () => {
            const tbody = document.querySelector("#searchTable tbody");
            const selectAllCheckbox = document.getElementById("selectAllCheckbox");

            // 1. è‡ªå‹•ç²å–æª”å
            const path = window.location.pathname;
            let pageName = path.split("/").pop().split(".")[0] ;
            
            // æ›´æ–°ä»‹é¢æ–‡å­—
            document.getElementById('sheetInfo').textContent = `ğŸ“Œ è³‡æ–™ä¾†æºï¼šå·¥ä½œè¡¨ [${pageName}]`;

            // 2. çµ„åˆ API é€£çµ
            const sheetURL = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(pageName)}`;

            // å»ºç«‹æŒ‰éˆ•çµ„
            function createBtnGroup(arr, defaultVal, symbol = "") {
                const td = document.createElement("td");
                const group = document.createElement("div");
                group.className = "btn-group";
                group.dataset.value = defaultVal;

                arr.forEach(val => {
                    const btn = document.createElement("button");
                    if (Array.isArray(val)) {
                        btn.textContent = val[1] + val[0];
                        btn.dataset.val = val[0];
                    } else {
                        btn.textContent = (val === "any" ? symbol : val);
                        btn.dataset.val = val;
                    }

                    if ((Array.isArray(val) && val[0] === defaultVal) || val === defaultVal) {
                        btn.classList.add("selected");
                    }

                    btn.addEventListener("click", () => {
                        group.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
                        btn.classList.add("selected");
                        group.dataset.value = btn.dataset.val;
                    });
                    group.appendChild(btn);
                });

                td.appendChild(group);
                return td;
            }

            try {
                // 3. è®€å–èˆ‡è§£æ CSV
                const res = await fetch(sheetURL);
                if (!res.ok) throw new Error("æ¬Šé™ä¸è¶³æˆ–å·¥ä½œè¡¨ä¸å­˜åœ¨");
                const data = await res.text();
                
                const lines = data.split('\n')
                    .map(l => l.trim().replace(/^"|"$/g, '')) // ç§»é™¤é›™å¼•è™Ÿ
                    .filter(l => l && !l.startsWith('<!DOCTYPE')); // æ’é™¤ç©ºè¡Œèˆ‡éŒ¯èª¤ç¶²é 

                tbody.innerHTML = ""; // æ¸…é™¤è¼‰å…¥ä¸­æ–‡å­—

                lines.forEach(line => {
                    // æ”¯æ´å¤šé—œéµå­—åˆä½µ (ä¾‹å¦‚ A,B,C è®Šæˆ (A OR B OR C))
                    const names = line.split(',').map(n => n.trim()).filter(Boolean);
                    if (names.length === 0) return;
                    
                    const keywordQuery = names.length > 1 ? `(${names.join(' OR ')})` : names[0];
                    
                    const tr = document.createElement("tr");

                    // 1. æ ¸å–æ¡†
                    const tdCheck = document.createElement("td");
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.checked = true;
                    tdCheck.appendChild(checkbox);
                    tr.appendChild(tdCheck);

                    // 2. é—œéµå­—é¡¯ç¤º
                    const tdKeyword = document.createElement("td");
                    tdKeyword.textContent = names.join(' / ');
                    tr.appendChild(tdKeyword);

                    // 3. æ„›å¿ƒ (é è¨­åŒæ­¥æ¨™é ­)
                    tr.appendChild(createBtnGroup(["any", 10, 100], "10", "â¤ï¸"));

                    // 4. æ—¥æœŸ (é è¨­åŒæ­¥æ¨™é ­)
                    tr.appendChild(createBtnGroup(["any", 1, 7, 30], "7", "ğŸ“…"));

                    // 5. æ’åº
                    tr.appendChild(createBtnGroup([["live", "âœ¨"], ["top", "ğŸ”¥"]], "live"));

                    // 6. å–®åˆ—æœå°‹æŒ‰éˆ•
                    const tdLink = document.createElement("td");
                    const linkBtn = document.createElement("button");
                    linkBtn.className = "link-btn";
                    linkBtn.textContent = "ğŸ”—";

                    const openSearch = () => {
                        const faves = tr.cells[2].querySelector(".btn-group").dataset.value;
                        const days = tr.cells[3].querySelector(".btn-group").dataset.value;
                        const sort = tr.cells[4].querySelector(".btn-group").dataset.value;
                        
                        let query = keywordQuery;
                        if (faves !== "any") query += " min_faves:" + faves;
                        
                        if (days !== "any") {
                            const date = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                            query += ` since:${date}`;
                        }
                        
                        let url = `https://x.com/search?q=${encodeURIComponent(query)}&f=${sort}`;
                        window.open(url, "_blank");
                    };

                    linkBtn.addEventListener("click", openSearch);
                    tdLink.appendChild(linkBtn);
                    tr.appendChild(tdLink);

                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="6" style="color:red;">âŒ è®€å–å¤±æ•—ï¼šè«‹æª¢æŸ¥è©¦ç®—è¡¨å…±ç”¨æ¬Šé™èˆ‡å·¥ä½œè¡¨åç¨±æ˜¯å¦ç‚º [${pageName}]</td></tr>`;
            }

            // å…¨é¸é‚è¼¯
            selectAllCheckbox.addEventListener("change", () => {
                const checked = selectAllCheckbox.checked;
                document.querySelectorAll("#searchTable tbody tr input[type=checkbox]").forEach(cb => cb.checked = checked);
            });

            // è¡¨é ­çµ±ä¸€æ§åˆ¶æ¬„ä½
            function setupHeaderControl(headerId, colIndex) {
                const header = document.getElementById(headerId);
                header.querySelectorAll("button").forEach(btn => {
                    btn.addEventListener("click", () => {
                        header.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
                        btn.classList.add("selected");
                        const val = btn.dataset.val;
                        document.querySelectorAll(`#searchTable tbody tr`).forEach(tr => {
                            const g = tr.cells[colIndex].querySelector(".btn-group");
                            g.dataset.value = val;
                            g.querySelectorAll("button").forEach(b => {
                                b.classList.toggle("selected", b.dataset.val === val);
                            });
                        });
                    });
                });
            }
            setupHeaderControl("favesHeader", 2);
            setupHeaderControl("daysHeader", 3);
            setupHeaderControl("sortHeader", 4);

            // ğŸŒ é–‹å•Ÿæ‰€æœ‰é¸ä¸­
            document.getElementById("openSelected").addEventListener("click", () => {
                const selectedRows = [...document.querySelectorAll("#searchTable tbody tr")].filter(tr => tr.querySelector("input[type=checkbox]").checked);
                if (selectedRows.length > 5) {
                    if (!confirm(`å³å°‡é–‹å•Ÿ ${selectedRows.length} å€‹åˆ†é ï¼Œç¢ºå®šå—ï¼Ÿ`)) return;
                }
                selectedRows.forEach((tr, i) => {
                    setTimeout(() => {
                        tr.querySelector(".link-btn").click();
                    }, i * 500); // å¢åŠ é–“éš”é¿å…ç€è¦½å™¨é˜»æ“‹
                });
            });
        });
    </script>
</body>
</html>